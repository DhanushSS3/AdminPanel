<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 250px;
            min-width: 250px;
            max-width: 250px;
            background-color: #343a40;
            color: white;
            padding: 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .sidebar h4 {
            margin-bottom: 20px;
        }

        .sidebar a {
            color: white;
            text-decoration: none;
            padding: 10px 15px;
            margin-bottom: 5px;
            display: block;
        }

        .sidebar a.active {
            background-color: #007bff;
            border-radius: 5px;
        }

        .content {
            flex-grow: 1;
            padding: 20px;
            height: 100%;
            overflow-y: auto;
        }

        .search-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .search-container input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .table-container {
            overflow-x: auto;
        }

        .table-container table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .table-container th,
        .table-container td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            word-wrap: break-word;
        }

        .table-container th {
            background-color: #f2f2f2;
        }

        #live-customers-content,
        #demo-customers-content,
        #groups-content,
        #orders-content,
        #money-requests-content {
            display: none;
        }

        #live-customers-content {
            display: block;
        }


        .user-settings-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .form-actions {
            text-align: right;
        }

        .close-popup {
            padding: 8px 15px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
        }
        
        #orders-content .search-container,
        #orders-content .mb-3,
        #orders-content #filterOrdersButton {
            display: block; /* Make each element a block-level element */
            width: 100%; /* Ensure elements take full width */
            margin-bottom: 10px; /* Add spacing between elements */
        }

        #orders-content .search-container {
            display: grid;
            grid-template-columns: auto auto auto auto;
            gap: 10px;
            align-items: center;
        }
        
        #orders-content .search-container > * {
            margin: 0;
        }
        
        #orders-content .search-container h2 {
            grid-column: 1 / -1;
            margin-bottom: 10px;
        }
        
        #orders-content .search-container label {
            display: block;
            margin-bottom: 5px;
        }
        
        #orders-content .search-container input,
        #orders-content .search-container select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        
        /* Increase the width of the select elements */
        #orders-content .search-container select.form-select {
            width: calc(100% - 20px); /* Adjust width for padding/border */
            min-width: 150px; /* Set a minimum width */
        }
        
        #orders-content .search-container .search-input {
            width: calc(100% - 20px); /* Adjust width for padding/border */
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <h4>Hello Admin</h4>
        <a href="#" class="active" id="live-customer-link">Live Customer</a>
        <a href="#" id="demo-customer-link">Demo Customer</a>
        <a href="#" id="groups-link">Group</a>
        <a href="#" id="orders-link">Order</a>
        <!--<a href="#" id="money-requests-link">Money Requests</a>-->
        <a href="#" id="logout-link">Logout</a>
    </div>

    <div class="content">

        <div id="live-customers-content" class="table-container">
            <div class="search-container" id="live-customers-search">
                <h2>Live Customers</h2>
                <input type="text" placeholder="Search Live Customers" class="search-input" data-search-target="live-customers">
            </div>
            <table class="table table-striped" id="live-customer-table">
                <thead>
                    <tr>
                        <th>Sr. No.</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone No</th>
                        <th>Balance</th>
                        <th>Account Number</th>
                        <th>Account Status</th>
                        <th>Leverage</th>
                        <th>Registration Date</th>
                        <th>Group</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div class="modal fade" id="userTradesModal" tabindex="-1" aria-labelledby="userTradesModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="userTradesModalLabel">User Trades</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="userTradesModalBody">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Sr No</th>
                                    <th>User Name</th>
                                    <th>Email</th>
                                    <th>Phone Number</th>
                                    <th>Order Id</th>
                                    <th>Order Status</th>
                                    <th>Company Name</th>
                                    <th>Order Type</th>
                                    <th>Open Price</th>
                                    <th>Quantity</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="demo-customers-content" class="table-container">
            <div class="search-container" id="demo-customers-search">
                <h2>Demo Customers</h2>
                <input type="text" placeholder="Search Demo Customers" class="search-input" data-search-target="demo-customers">
            </div>
            <table class="table table-striped" id="demo-customer-table">
                <thead>
                    <tr>
                        <th>Sr. No.</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone No</th>
                        <th>Balance</th>
                        <th>Account Number</th>
                        <th>Account Status</th>
                        <th>Leverage</th>
                        <th>Registration Date</th>
                        <th>Group</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        
        <div id="groups-content" class="table-container">
            <div class="filter-container">
                <select id="groupNameFilter">
                    <option value="">All Group Names</option>
                </select>
                <select id="groupSymbolFilter">
                    <option value="">All Group Symbols</option>
                </select>
                <button id="filterGroupsButton" class="btn btn-primary btn-sm">Filter</button>
                <button type="button" class="btn btn-primary" id="addGroupButton">Add Group</button>
            </div>
            <table class="table table-striped" id="groups-table">
                <thead>
                    <tr>
                        <th>Sr. No.</th>
                        <th>Symbol</th>
                        <th>Name</th>
                        <th>Commission</th>
                        <th>Commission Type</th>
                        <th>Commission Value Type</th>
                        <th>Margin</th>
                        <th>Spread</th>
                        <th>Deviation</th>
                        <th>Min Lot</th>
                        <th>Max Lot</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <div class="modal fade" id="addGroupModal" tabindex="-1" aria-labelledby="addGroupModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addGroupModalLabel">Create Group</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addGroupForm">
                            <div class="mb-3">
                                <label for="name" class="form-label">Name</label>
                                <input type="text" class="form-control" id="name" required>
                            </div>
                            <div class="mb-3">
                                <label for="symbol" class="form-label">Symbol Name</label>
                                <select class="form-select" id="symbol" required>
                                    <option value="">Select Symbol</option> </select>
                            </div>
                            <div class="mb-3">
                                <label for="commissionAmount" class="form-label">Commission</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="commissionAmount" placeholder="Commission" required>
                                    <select class="form-select" id="commissionInOut">
                                        <option value="in">In</option>
                                        <option value="out">Out</option>
                                        <option value="every">Every Trade</option>
                                    </select>
                                    <select class="form-select" id="commissionValueType">
                                        <option value="value">Value</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="symbolType" class="form-label">Symbol Type</label>
                                <select class="form-select" id="symbolType" required>
                                    <option value="">Select Symbol Type</option>
                                    <option value="1">Currency Pair</option>
                                    <option value="2">Commodities</option>
                                    <option value="3">Indices</option>
                                    <option value="4">Crypto</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="swapBuy" class="form-label">Swap Buy</label>
                                <input type="text" class="form-control" id="swapBuy" placeholder="Swap Buy">
                            </div>
                            <div class="mb-3">
                                <label for="swapSell" class="form-label">Swap Sell</label>
                                <input type="text" class="form-control" id="swapSell" placeholder="Swap Sell">
                            </div>
                            <div class="mb-3">
                                <label for="margin" class="form-label">Margin</label>
                                <input type="number" class="form-control" id="margin" placeholder="Margin">
                            </div>
                            <div class="mb-3">
                                <label for="spread" class="form-label">Spread</label>
                                <input type="number" class="form-control" id="spread" placeholder="Spread">
                            </div>
                            <div class="mb-3">
                                <label for="deviation" class="form-label">Deviation</label>
                                <input type="number" class="form-control" id="deviation" placeholder="Deviation">
                            </div>
                            <div class="mb-3">
                                <label for="minLot" class="form-label">Min Lot</label>
                                <input type="number" class="form-control" id="minLot" placeholder="Min Lot">
                            </div>
                            <div class="mb-3">
                                <label for="maxLot" class="form-label">Max Lot</label>
                                <input type="number" class="form-control" id="maxLot" placeholder="Max Lot">
                            </div>
                            <div class="mb-3">
                                <label for="pips" class="form-label">Pips</label>
                                <input type="number" class="form-control" id="pips" placeholder="Pips">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="submitGroup">Add</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="orders-content" class="table-container">
            <div class="search-container" id="orders-search">
                <h2>Orders</h2>
                <div>
                    <label for="orderStatusFilter">Order Status</label>
                    <select class="form-select" id="orderStatusFilter">
                        <option value="">All</option>
                        <option value="open">Open</option>
                        <option value="pending">Pending</option>
                        <option value="close">Close</option>
                    </select>
                </div>
                <div>
                    <label for="orderTypeFilter">Order Type</label>
                    <select class="form-select" id="orderTypeFilter">
                        <option value="">All</option>
                        <option value="BUY">BUY</option>
                        <option value="SELL">SELL</option>
                    </select>
                </div>
                <div>
                    <label for="orderTimeFilter">Order Time</label>
                    <input type="date" id="orderTimeFilter">
                </div>
                <div>
                    <label for="ordersSearch">Search</label>
                    <input type="text" placeholder="Search Orders" class="search-input" data-search-target="orders" id="ordersSearch">
                </div>
            </div>
            <button id="filterOrdersButton" class="btn btn-primary">Filter Orders</button>
            <table class="table table-striped" id="orders-table">
                <thead>
                    <tr>
                        <th>Sr. No.</th>
                        <th>Order ID</th>
                        <th>Order Status</th>
                        <th>User ID</th>
                        <th>Company Name</th>
                        <th>Order Type</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Contract Value</th>
                        <th>Margin</th>
                        <th>Net Profit</th>
                        <th>Close Price</th>
                        <th>Swap</th>
                        <th>Commission</th>
                        <th>Created At</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
       <!-- <div id="money-requests-content" class="table-container">
            <div class="search-container" id="money-requests-search">
                <h2>Money Requests</h2>
                <input type="text" placeholder="Search Money Requests" class="search-input" data-search-target="money-requests">
            </div>
            <table class="table table-striped" id="money-requests-table">
                <thead>
                    <tr>
                        <th>Sr. No.</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone Number</th>
                        <th>Request Amount</th>
                        <th>Request Type</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>-->
    </div>
    <div class="modal fade" id="userKycModal" tabindex="-1" aria-labelledby="userKycModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userKycModalLabel">User KYC Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="userKycModalBody">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="manageFundsModal" tabindex="-1" aria-labelledby="manageFundsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageFundsModalLabel">Manage Funds for <span id="customerName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Customer ID: <span id="customerId"></span></p>
    
                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount</label>
                        <input type="number" class="form-control" id="amount" placeholder="Enter amount">
                    </div>
                    <div class="mb-3">
                        <label for="transactionType" class="form-label">Transaction Type</label>
                        <select class="form-select" id="transactionType">
                            <option value="credit">Add Funds</option>
                            <option value="debit">Withdraw Funds</option>
                        </select>
                    </div>
    
                    <hr>
                    <h4>Transaction History</h4>
                    <div class="table-responsive" style="height: 300px; overflow-y: auto;">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Sr No</th>
                                    <th>User Name</th>
                                    <th>Email</th>
                                    <th>Phone Number</th>
                                    <th>Wallet Balance</th>
                                    <th>Transaction Id</th>
                                    <th>Transaction Type</th>
                                    <th>Amount</th>
                                    <th>Date Time</th>
                                </tr>
                            </thead>
                            <tbody id="transactionHistory">
                            </tbody>
                        </table>
                    </div>
    
                    <div id="updateMessage" class="alert alert-success" style="display: none;">
                        Funds updated successfully.
                    </div>
                    <div id="errorMessage" class="alert alert-danger" style="display: none;">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="submitFunds">Submit</button>
                </div>
            </div>
        </div>
        
        
    </div>

    <script>
        const liveCustomerLink = document.getElementById('live-customer-link');
        const demoCustomerLink = document.getElementById('demo-customer-link');
        const groupsLink = document.getElementById('groups-link');
        const ordersLink = document.getElementById('orders-link');
        /*const moneyRequestsLink = document.getElementById('money-requests-link');*/

        /*const moneyRequestsContent = document.getElementById('money-requests-content');*/
        const liveCustomersContent = document.getElementById('live-customers-content');
        const demoCustomersContent = document.getElementById('demo-customers-content');
        const groupsContent = document.getElementById('groups-content');
        const ordersContent = document.getElementById('orders-content');

        const liveCustomerTableBody = document.querySelector('#live-customer-table tbody');
        const demoCustomerTableBody = document.querySelector('#demo-customer-table tbody');
        const groupsTableBody = document.querySelector('#groups-table tbody');
        const ordersTableBody = document.querySelector('#orders-table tbody');
        /*const moneyRequestsTableBody = document.querySelector('#money-requests-table tbody');*/


        function initializePage() {
            liveCustomerLink.classList.add('active'); // Add active class to live customer link
            liveCustomersContent.style.display = 'block'; // Show live customers content
            demoCustomersContent.style.display = 'none'; // Hide other content
            groupsContent.style.display = 'none';
            ordersContent.style.display = 'none';
           /* moneyRequestsContent.style.display = 'none';*/
            fetchAndDisplayLiveCustomers(); // Fetch and display live customers
            populateDropdowns(); // Populate the dropdowns
        }
        initializePage();

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function createDropdown(item, type) {
            const dropdown = document.createElement('div');
            dropdown.classList.add('dropdown');
        
            const button = document.createElement('button');
            button.classList.add('btn', 'btn-sm', 'dropdown-toggle');
            button.innerHTML = '&#9776;';
            button.setAttribute('data-bs-toggle', 'dropdown');
            button.setAttribute('aria-expanded', 'false');
        
            const menu = document.createElement('ul');
            menu.classList.add('dropdown-menu');
        
            if (type === 'liveCustomer' || type === 'demoCustomer') {
                let options = [
                    { label: 'Manage Funds', action: () => manageFunds(item) },
                    { label: 'Trades', action: () => trades(item) },
                    { label: 'User Setting', action: () => userSetting(item) },
                    { label: 'Block/Unblock User', action: () => blockUnblockUser(item) },
                ];
        
                if (type === 'liveCustomer') {
                    options.push({ label: 'User Kyc', action: () => userKyc(item) });
                }
        
                options.forEach(option => {
                    const itemElement = document.createElement('li');
                    const link = document.createElement('a');
                    link.classList.add('dropdown-item');
                    link.href = '#';
                    link.textContent = option.label;
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        option.action();
                    });
                    itemElement.appendChild(link);
                    menu.appendChild(itemElement);
                });
            } else if (type === 'groups') {
                const itemElement = document.createElement('li');
                itemElement.textContent = "No Group Actions";
                menu.appendChild(itemElement);
        
            } /*else if (type === 'moneyRequests') {
                const itemElement = document.createElement('li');
                itemElement.textContent = "No Money Request Actions";
                menu.appendChild(itemElement);
            }*/
        
            dropdown.appendChild(button);
            dropdown.appendChild(menu);
        
            return dropdown;
        }
        
        /*function createDropdown(item, type) { // Add 'type' parameter
            const dropdown = document.createElement('div');
            dropdown.classList.add('dropdown');

            const button = document.createElement('button');
            button.classList.add('btn', 'btn-sm', 'dropdown-toggle');
            button.innerHTML = '&#9776;';
            button.setAttribute('data-bs-toggle', 'dropdown');
            button.setAttribute('aria-expanded', 'false');

            const menu = document.createElement('ul');
            menu.classList.add('dropdown-menu');

            if (type === 'liveCustomer') { // Conditionally add options
                const options = [
                    { label: 'Manage Funds', action: () => manageFunds(item) },
                    { label: 'Trades', action: () => trades(item) },
                    { label: 'User Setting', action: () => userSetting(item) },
                    { label: 'User Kyc', action: () => userKyc(item) },
                    { label: 'Block User', action: () => blockUser(item) }
                ];

                options.forEach(option => {
                    const itemElement = document.createElement('li');
                    const link = document.createElement('a');
                    link.classList.add('dropdown-item');
                    link.href = '#';
                    link.textContent = option.label;
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        option.action();
                    });
                    itemElement.appendChild(link);
                    menu.appendChild(itemElement);
                });
            } else if (type === 'demoCustomer') { // Different actions for demo
                const itemElement = document.createElement('li');
                itemElement.textContent = "No Demo Actions";
                menu.appendChild(itemElement);
            } else if (type === 'groups'){
                const itemElement = document.createElement('li');
                itemElement.textContent = "No Group Actions";
                menu.appendChild(itemElement);
            } else if(type === 'orders'){
                const itemElement = document.createElement('li');
                itemElement.textContent = "No Order Actions";
                menu.appendChild(itemElement);
            } else if(type === 'moneyRequests'){
                const itemElement = document.createElement('li');
                itemElement.textContent = "No Money Request Actions";
                menu.appendChild(itemElement);
            }

            dropdown.appendChild(button);
            dropdown.appendChild(menu);

            return dropdown;
        }*/



        async function blockUnblockUser(item) {
            const userId = item.id; // Correctly uses item.id
            const currentStatus = item.status;
        
            const newStatus = currentStatus === 1 ? 0 : 1;
            const action = newStatus === 0 ? "block" : "unblock";
            const confirmationMessage = `Are you sure you want to ${action} this user?`;
        
            if (!confirm(confirmationMessage)) {
                return;
            }
        
            try {
                const accessToken = localStorage.getItem('access_token');
                if (!accessToken) {
                    alert('Authentication required.');
                    return;
                }
        
                const response = await fetch('/accounts/api/block-unblock/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`,
                    },
                    body: JSON.stringify({ id: userId, status: newStatus }), // correctly using id
                });
        
                if (!response.ok) {
                    const errorData = await response.json();
                    alert(`Failed to ${action} user: ${errorData.message || response.statusText}`);
                    return;
                }
        
                alert(`User ${action}ed successfully.`);
                item.status = newStatus;
                // ... UI update logic
            } catch (error) {
                console.error(`Error ${action}ing user:`, error);
                alert(`An error occurred while ${action}ing user.`);
            }
        }

        async function manageFunds(customer) {
            document.getElementById('customerName').textContent = customer.name;
            document.getElementById('customerId').textContent = customer.id;
        
            const manageFundsModal = new bootstrap.Modal(document.getElementById('manageFundsModal'));
            const token = localStorage.getItem('access_token');
            manageFundsModal.show();
        
            // Fetch initial transaction history (optional, you can move this inside submitFunds if you only want to load it after an update)
            try {
                const historyResponse = await fetch(`/accounts/api/wallet-transactions/${customer.id}/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                });
        
                if (historyResponse.ok) {
                    const updatedTransactions = await historyResponse.json();
                    const transactionTable = document.getElementById('transactionHistory');
                    transactionTable.innerHTML = '';
        
                    updatedTransactions.forEach((transaction, index) => {
                        const row = transactionTable.insertRow();
                        row.insertCell(0).textContent = index + 1; // Sr No
                        row.insertCell(1).textContent = transaction.name;
                        row.insertCell(2).textContent = transaction.email;
                        row.insertCell(3).textContent = transaction.phone_number;
                        row.insertCell(4).textContent = transaction.wallet_total_amount + ' $';
                        row.insertCell(5).textContent = transaction.transaction_id || 'N/A';
                        row.insertCell(6).textContent = transaction.transaction_type;
                        row.insertCell(7).textContent = transaction.transaction_amount + ' $';
                        row.insertCell(8).textContent = transaction.transaction_time;
                    });
                } else {
                    console.error('Failed to refetch transaction history.');
                }
            } catch (error) {
                console.error('Error refetching transactions:', error);
            }
        
            document.getElementById('submitFunds').addEventListener('click', async () => {
                const amount = document.getElementById('amount').value;
                const transactionType = document.getElementById('transactionType').value;
        
                if (!amount) {
                    alert('Please enter an amount.');
                    return;
                }
        
                try {
                    const response = await fetch('/accounts/api/update-customer-funds/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`,
                            'X-CSRFToken': getCookie('csrftoken'),
                        },
                        body: JSON.stringify({
                            customer_id: customer.id,
                            amount: amount,
                            transaction_type: transactionType,
                        }),
                    });
        
                    if (response.ok) {
                        // Show the Bootstrap success alert
                        document.getElementById('updateMessage').style.display = 'block';
        
                        // Refetch and update the transaction history *after* the update
                        try {
                            const historyResponse = await fetch(`/accounts/api/wallet-transactions/${customer.id}/`, {
                                headers: {
                                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                                },
                            });
        
                            if (historyResponse.ok) {
                                const updatedTransactions = await historyResponse.json();
                                const transactionTable = document.getElementById('transactionHistory');
                                transactionTable.innerHTML = '';
        
                                updatedTransactions.forEach((transaction, index) => {
                                    const row = transactionTable.insertRow();
                                    row.insertCell(0).textContent = index + 1; // Sr No
                                    row.insertCell(1).textContent = transaction.name;
                                    row.insertCell(2).textContent = transaction.email;
                                    row.insertCell(3).textContent = transaction.phone_number;
                                    row.insertCell(4).textContent = transaction.wallet_total_amount + ' $';
                                    row.insertCell(5).textContent = transaction.trasaction_id || 'N/A';
                                    row.insertCell(6).textContent = transaction.transaction_type;
                                    row.insertCell(7).textContent = transaction.transaction_amount + ' $';
                                    row.insertCell(8).textContent = transaction.transaction_time;
                                });
                            } else {
                                console.error('Failed to refetch transaction history.');
                            }
                        } catch (error) {
                            console.error('Error refetching transactions:', error);
                        }
        
                        // Hide the Bootstrap alert after a delay
                        setTimeout(() => {
                            document.getElementById('updateMessage').style.display = 'none';
                        }, 3000);
        
                        // Reload the webpage
                        location.reload();
        
                    } else {
                        const errorData = await response.json();
                        //show the error message
                        document.getElementById('errorMessage').textContent = `Error: ${errorData.error || 'Failed to update funds.'}`;
                        document.getElementById('errorMessage').style.display = 'block';
                        setTimeout(() => {
                            document.getElementById('errorMessage').style.display = 'none';
                        }, 3000);
                    }
                } catch (error) {
                    console.error('Error updating funds:', error);
                    alert('An error occurred while updating funds.');
                }
            });
        }

        async function updateCustomerDetails(customerId, newBalance, newGroupName) {
            const accessToken = localStorage.getItem('access_token');
            const url = `/accounts/api/customers/${customerId}/update_customer_details/`;
            try {
                const response = await fetch(url, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        wallet_total_amount: newBalance,
                        group: newGroupName // Send the group name
                    })
                });
        
                if (response.ok) {
                    console.log("Customer details updated successfully");
                    fetchAndDisplayLiveCustomers();
                } else {
                    const errorData = await response.json();
                    console.error("Error updating customer details:", errorData);
                    alert("Failed to update customer details. Please check the console for details.");
                }
        
            } catch (error) {
                console.error("Network error updating customer details:", error);
                alert("Network error updating customer details. Please try again.");
            }
        }
        
        async function fetchGroupNames() {
            const accessToken = localStorage.getItem('access_token');
            const url = '/accounts/api/groups/';
        
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
        
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
        
                const data = await response.json();
                return [...new Set(data.map(group => group.name))]; // Extract unique group names
            } catch (error) {
                console.error("Error fetching group names:", error);
                return [];
            }
        }
        
        async function userSetting(customer) {
            // Create the popup container
            const popup = document.createElement('div');
            popup.classList.add('user-settings-popup');
            const groupNames = await fetchGroupNames();

            // Populate the popup with user settings data
            popup.innerHTML = `
                <h2>User Settings</h2>
                <div class="form-group">
                    <label for="name">Name</label>
                    <input type="text" id="name" value="${customer.name || 'NA'}" readonly>
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" value="${customer.email || 'NA'}" readonly>
                </div>
                <div class="form-group">
                    <label for="phone">Phone</label>
                    <input type="tel" id="phone" value="${customer.phone_number || 'NA'}" readonly>
                </div>
                <div class="form-group">
                    <label for="phone_number">Phone Number</label>
                    <input type="tel" id="phone_number" value="${customer.phone_number || 'NA'}" readonly>
                </div>
                <div class="form-group">
                    <label for="bank_account_number">Bank Account Number</label>
                    <input type="text" id="bank_account_number" value="${customer.bank_account_number || 'NA'}" readonly>
                </div>
                <div class="form-group">
                    <label for="bank_ifsc_code">Bank IFSC Code</label>
                    <input type="text" id="bank_ifsc_code" value="${customer.bank_ifsc_code || 'NA'}" readonly>
                </div>
                <div class="form-group">
                    <label for="balance">Balance</label>
                    <input type="number" id="balance" value="${customer.wallet_total_amount || 0}">
                </div>
                <div class="form-group">
                    <label for="group">Group</label>
                    <select id="group">
                        <option value="">Select Group</option>
                        ${groupNames.map(name => `<option value="${name}" ${customer.group === name ? 'selected' : ''}>${name}</option>`).join('')}
                    </select>
                </div>
                <div class="form-actions">
                    <button class="add-balance">Add</button>
                    <button class="cancel-balance">Cancel</button>
                </div>
            `;
        
            // Append the popup to the body
            document.body.appendChild(popup);
        
            // Add event listener to close the popup
            popup.querySelector('.cancel-balance').addEventListener('click', () => {
                document.body.removeChild(popup);
            });
        
            // Add event listener to update the balance
            popup.querySelector('.add-balance').addEventListener('click', () => {
                const newBalance = popup.querySelector('#balance').value;
                const newGroupId = popup.querySelector('#group').value;
                updateCustomerDetails(customer.id, newBalance, newGroupId); // Use the new function name
                document.body.removeChild(popup);
            });
        }
        
        // Example usage:
        // Assuming you have a customer object available, e.g., from a table row click:
        // userSetting(customer);
        /*function userSetting(customer) {
            // Create the popup container
            const popup = document.createElement('div');
            popup.classList.add('user-settings-popup');
        
            // Populate the popup with user settings data
            popup.innerHTML = `
                <h2>User Settings</h2>
                <div class="form-group">
                    <label for="name">Name</label>
                    <input type="text" id="name" value="${customer.name || 'NA'}" readonly>
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" value="${customer.email || 'NA'}" readonly>
                </div>
                <div class="form-group">
                    <label for="phone">Phone</label>
                    <input type="tel" id="phone" value="${customer.phone_number || 'NA'}" readonly>
                </div>
                <div class="form-group">
                    <label for="phone_number">Phone Number</label>
                    <input type="tel" id="phone_number" value="${customer.phone_number || 'NA'}" readonly>
                </div>
                <div class="form-group">
                    <label for="bank_account_number">Bank Account Number</label>
                    <input type="text" id="bank_account_number" value="${customer.bank_account_number || 'NA'}" readonly>
                </div>
                <div class="form-group">
                    <label for="bank_ifsc_code">Bank IFSC Code</label>
                    <input type="text" id="bank_ifsc_code" value="${customer.bank_ifsc_code || 'NA'}" readonly>
                </div>
                <div class="form-group">
                    <label for="balance">Balance</label>
                    <input type="number" id="balance" value="${customer.wallet_total_amount || 0}">
                </div>
                <div class="form-actions">
                    <button class="add-balance">Add</button>
                    <button class="cancel-balance">Cancel</button>
                </div>
            `;
        
            // Append the popup to the body
            document.body.appendChild(popup);
        
            // Add event listener to close the popup
            popup.querySelector('.cancel-balance').addEventListener('click', () => {
                document.body.removeChild(popup);
            });
        
            // Add event listener to update the balance
            popup.querySelector('.add-balance').addEventListener('click', () => {
                const newBalance = popup.querySelector('#balance').value;
                updateBalance(customer.id, newBalance); // Call function to update balance
                document.body.removeChild(popup);
            });
        }*/

        async function userKyc(item) {
            const userId = item.id;
            console.log("User ID:", userId); // Log the user ID
            const modalBody = document.getElementById('userKycModalBody');
            modalBody.innerHTML = 'Loading...';
        
            try {
                console.log("Fetching KYC details for user ID:", userId);
                /*const response = await fetch(`/accounts/api/user-kyc/${userId}/`);*/
                const accessToken = localStorage.getItem('access_token');
                const response = await fetch(`/accounts/api/user-kyc/${userId}/`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                    },
                });
                console.log("API response status:", response.status); // Log the response status
        
                if (!response.ok) {
                    console.error("API response not OK:", response.statusText);
                    modalBody.innerHTML = 'Failed to load KYC details (API error).';
                    return;
                }
        
                const userData = await response.json();
                console.log("User data:", userData); // Log the received user data
        
                let html = `
                    <p><strong>Name:</strong> ${userData.name}</p>
                    <p><strong>Email:</strong> ${userData.email}</p>
                    <p><strong>Phone Number:</strong> ${userData.phone_number}</p>
                    <p><strong>State:</strong> ${userData.state}</p>
                    <p><strong>City:</strong> ${userData.city}</p>
                    <p><strong>Pincode:</strong> ${userData.pincode}</p>
                    <p><strong>Address Proof:</strong> ${userData.address_proof}</p>
                    <p><strong>Address Proof Image:</strong></p>
                    <img src="/images/${userData.address_proof_image}" alt="Address Proof Image" style="max-width: 200px; max-height: 200px;">
                    <p><strong>ID Proof:</strong> ${userData.id_proof}</p>
                    <p><strong>ID Proof Image:</strong></p>
                    <img src="/images/${userData.id_proof_image}" alt="ID Proof Image" style="max-width: 200px; max-height: 200px;">
                    
                `;
               
                modalBody.innerHTML = html;
                const modal = new bootstrap.Modal(document.getElementById('userKycModal'));
                modal.show();
        
            } catch (error) {
                console.error('Error fetching KYC details:', error);
                modalBody.innerHTML = 'Failed to load KYC details (network error).';
            }
        }

        function trades(customer) {
            const userId = customer.id;
            const accessToken = localStorage.getItem('access_token');
        
            fetch(`/accounts/api/user-trades/${userId}/`, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error fetching user trades:', data.error);
                    return;
                }
        
                const user = data.user;
                const orders = data.orders;
        
                const tableBody = document.querySelector('#userTradesModalBody tbody');
                tableBody.innerHTML = '';
        
                orders.forEach((order, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.phone_number}</td>
                        <td>${order.order_id}</td>
                        <td>${order.order_status}</td>
                        <td>${order.order_company_name}</td>
                        <td>${order.order_type}</td>
                        <td>${order.order_price}</td>
                        <td>${order.order_quantity}</td>
                    `;
                    tableBody.appendChild(row);
                });
        
                const userTradesModal = new bootstrap.Modal(document.getElementById('userTradesModal'));
                userTradesModal.show();
            })
            .catch(error => {
                console.error('Error fetching user trades:', error);
            });
        }

        async function fetchAndDisplayLiveCustomers(searchTerm = '') {
            const accessToken = localStorage.getItem('access_token');
            let url = '/accounts/api/live-user-profiles/';
            if (searchTerm) {
                url += `?search=${searchTerm}`;
            }
        
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
        
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/static/accounts/login.html';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
        
                const data = await response.json();
                console.log("Live Customer Data:", data);
        
                liveCustomerTableBody.innerHTML = '';

                data.forEach((customer, index) => {
                    const row = liveCustomerTableBody.insertRow();

                    const srNoCell = row.insertCell(0);
                    srNoCell.textContent = index + 1;

                    const nameCell = row.insertCell(1);
                    nameCell.textContent = customer.name || "NA";

                    const emailCell = row.insertCell(2);
                    emailCell.textContent = customer.email || "NA";

                    const phoneCell = row.insertCell(3);
                    phoneCell.textContent = customer.phone_number || "NA";

                    const walletAmountCell = row.insertCell(4);
                    walletAmountCell.textContent = customer.wallet_total_amount != null ? customer.wallet_total_amount : "NA";

                    const accountNumberCell = row.insertCell(5);
                    accountNumberCell.textContent = customer.account_number || "NA";

                    const accountStatusCell = row.insertCell(6);
                    accountStatusCell.textContent = customer.status || "NA";

                    const leverageCell = row.insertCell(7);
                    leverageCell.textContent = customer.leverage || "NA";


                    const registrationDateCell = row.insertCell(8);
                    if (customer.created_at) {
                        const registrationDate = new Date(customer.created_at);
                        const day = String(registrationDate.getDate()).padStart(2, '0');
                        const month = String(registrationDate.getMonth() + 1).padStart(2, '0'); // Months are zero-indexed
                        const year = registrationDate.getFullYear();
                        const formattedDate = `${day}-${month}-${year}`; // Correct format: DD-MM-YYYY
                        registrationDateCell.textContent = formattedDate;
                    } else {
                        registrationDateCell.textContent = "NA";
                    }

                    const groupCell = row.insertCell(9);
                    groupCell.textContent = customer.group || "NA";

                    const actionsCell = row.insertCell(10);
                    const dropdown = createDropdown(customer, 'liveCustomer');
                    actionsCell.appendChild(dropdown);
                });

                liveCustomersContent.style.display = 'block';
                demoCustomersContent.style.display = 'none';
                groupsContent.style.display = 'none';
                ordersContent.style.display = 'none';
                /*moneyRequestsContent.style.display = 'none';*/
            } catch (error) {
                console.error("Error fetching live customers:", error);
            }
        }

        async function fetchAndDisplayDemoCustomers(searchTerm = '') {
            const accessToken = localStorage.getItem('access_token');
            let url = '/accounts/api/demo-user-profiles/';
            if (searchTerm) {
                url += `?search=${searchTerm}`;
            }
        
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
        
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/static/accounts/login.html';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
        
                const data = await response.json();
                console.log("Demo Customer Data:", data);
                demoCustomerTableBody.innerHTML = '';

                data.forEach((customer, index) => {
                    const row = demoCustomerTableBody.insertRow();

                    const srNoCell = row.insertCell(0);
                    srNoCell.textContent = index + 1;

                    const nameCell = row.insertCell(1);
                    nameCell.textContent = customer.name || "NA";

                    const emailCell = row.insertCell(2);
                    emailCell.textContent = customer.email || "NA";

                    const phoneCell = row.insertCell(3);
                    phoneCell.textContent = customer.phone_number || "NA";

                    const walletAmountCell = row.insertCell(4);
                    walletAmountCell.textContent = customer.wallet_total_amount != null ? customer.wallet_total_amount : "NA";

                    const accountNumberCell = row.insertCell(5);
                    accountNumberCell.textContent = customer.account_number || "NA";

                    const accountStatusCell = row.insertCell(6);
                    accountStatusCell.textContent = customer.status || "NA";

                    const leverageCell = row.insertCell(7);
                    leverageCell.textContent = customer.leverage || "NA";

                    const registrationDateCell = row.insertCell(8);
                    if (customer.created_at) {
                        const registrationDate = new Date(customer.created_at);
                        const day = String(registrationDate.getDate()).padStart(2, '0');
                        const month = String(registrationDate.getMonth() + 1).padStart(2, '0'); // Months are zero-indexed
                        const year = registrationDate.getFullYear();
                        const formattedDate = `${day}-${month}-${year}`; // Correct format: DD-MM-YYYY
                        registrationDateCell.textContent = formattedDate;
                    } else {
                        registrationDateCell.textContent = "NA";
                    }

                    const groupCell = row.insertCell(9);
                    groupCell.textContent = customer.group || "NA";

                    const actionsCell = row.insertCell(10);
                    const dropdown = createDropdown(customer, 'demoCustomer');
                    actionsCell.appendChild(dropdown);
                });

                liveCustomersContent.style.display = 'none';
                demoCustomersContent.style.display = 'block';
                groupsContent.style.display = 'none';
                ordersContent.style.display = 'none';
                /*moneyRequestsContent.style.display = 'none';*/
            } catch (error) {
                console.error("Error fetching demo customers:", error);
            }
            
        }

        const groupNameFilter = document.getElementById('groupNameFilter');
        const groupSymbolFilter = document.getElementById('groupSymbolFilter');

        // ... (Your existing code)

        document.getElementById('addGroupButton').addEventListener('click', async () => {
            const addGroupModal = new bootstrap.Modal(document.getElementById('addGroupModal'));
            addGroupModal.show();
        
            // Populate the symbol dropdown in the modal
            const symbols = await populateDropdowns();
            const symbolDropdown = document.getElementById('symbol');
        
            symbolDropdown.innerHTML = '<option value="">Select Symbol</option>'; // Reset dropdown
        
            symbols.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = symbol;
                symbolDropdown.appendChild(option);
            });
        });

        document.getElementById('submitGroup').addEventListener('click', async () => {
            const accessToken = localStorage.getItem('access_token');
            const form = document.getElementById('addGroupForm');
        
            // Clear any previous warnings
            document.getElementById('warningMessage')?.remove();
        
            // Validation
            const requiredFields = [
                { id: 'symbol', label: 'Symbol Name' },
                { id: 'name', label: 'Name' },
                { id: 'commissionAmount', label: 'Commission' },
                { id: 'symbolType', label: 'Symbol Type' },
                { id: 'swapBuy', label: 'Swap Buy' },
                { id: 'swapSell', label: 'Swap Sell' },
                { id: 'margin', label: 'Margin' },
                { id: 'spread', label: 'Spread' },
                { id: 'deviation', label: 'Deviation' },
                { id: 'minLot', label: 'Min Lot' },
                { id: 'maxLot', label: 'Max Lot' },
                { id: 'pips', label: 'Pips' },
            ];
        
            let hasErrors = false;
            for (const field of requiredFields) {
                const value = document.getElementById(field.id).value;
                if (!value) {
                    hasErrors = true;
                    break;
                }
            }
        
            if (hasErrors) {
                const warningDiv = document.createElement('div');
                warningDiv.id = 'warningMessage';
                warningDiv.className = 'alert alert-danger mt-3';
                warningDiv.textContent = 'Please fill in all required fields.';
                form.appendChild(warningDiv);
                return; // Stop submission
            }
        
            // If all fields are filled, proceed with submission
            const groupData = {
                symbol: form.symbol.value,
                name: form.name.value,
                commision: document.getElementById('commissionAmount').value,
                commision_type: document.getElementById('commissionInOut').value,
                commision_value_type: document.getElementById('commissionValueType').value,
                type: document.getElementById('symbolType').value,
                swap_buy: form.swapBuy.value,
                swap_sell: form.swapSell.value,
                margin: form.margin.value,
                spread: form.spread.value,
                deviation: form.deviation.value,
                min_lot: form.minLot.value,
                max_lot: form.maxLot.value,
                pips: form.pips.value,
                spread_pip: "", // Add default value, or get value from form if needed
                show_points: "", // Add this line!
                pip_currency: "",
            };
        
            try {
                const response = await fetch('/accounts/api/groups/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`,
                        'X-CSRFToken': getCookie('csrftoken'), // Assuming you have getCookie function
                    },
                    body: JSON.stringify(groupData),
                });
        
                if (response.ok) {
                    alert('Group added successfully!');
                    const addGroupModal = bootstrap.Modal.getInstance(document.getElementById('addGroupModal'));
                    addGroupModal.hide();
                    form.reset();
                    fetchAndDisplayGroups(groupNameFilter.value, groupSymbolFilter.value); // Refresh the table
                } else {
                    const errorData = await response.json();
                    alert(`Error adding group: ${errorData.error || response.statusText}`);
                }
            } catch (error) {
                console.error('Error adding group:', error);
                alert('An error occurred while adding the group.');
            }
        });

        async function fetchAndDisplayGroups(groupName = '', groupSymbol = '') {
            const accessToken = localStorage.getItem('access_token');
            let url = '/accounts/api/groups/';

            // Build query parameters for filtering
            const queryParams = new URLSearchParams();
            if (groupName) queryParams.append('name', groupName);
            if (groupSymbol) queryParams.append('symbol', groupSymbol);

            const queryString = queryParams.toString();
            if (queryString) url += `?${queryString}`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/static/accounts/login.html';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log("Group Data:", data);
                groupsTableBody.innerHTML = '';

                data.forEach((group, index) => {
                    const row = groupsTableBody.insertRow();

                    const srNoCell = row.insertCell(0);
                    srNoCell.textContent = index + 1;

                    const symbolCell = row.insertCell(1);
                    symbolCell.textContent = group.symbol || "NA";

                    const nameCell = row.insertCell(2);
                    nameCell.textContent = group.name || "NA";

                    const commissionCell = row.insertCell(3);
                    commissionCell.textContent = group.commision || "NA";

                    const commissionTypeCell = row.insertCell(4);
                    commissionTypeCell.textContent = group.commision_type || "NA";

                    const commissionValueTypeCell = row.insertCell(5);
                    commissionValueTypeCell.textContent = group.commision_value_type || "NA";

                    const marginCell = row.insertCell(6);
                    marginCell.textContent = group.margin || "NA";

                    const spreadCell = row.insertCell(7);
                    spreadCell.textContent = group.spread || "NA";

                    const deviationCell = row.insertCell(8);
                    deviationCell.textContent = group.deviation || "NA";

                    const minLotCell = row.insertCell(9);
                    minLotCell.textContent = group.min_lot || "NA";

                    const maxLotCell = row.insertCell(10);
                    maxLotCell.textContent = group.max_lot || "NA";

                    const actionsCell = row.insertCell(11);
                    const dropdown = createDropdown(group, 'groups');
                    actionsCell.appendChild(dropdown);
                });

                liveCustomersContent.style.display = 'none';
                demoCustomersContent.style.display = 'none';
                groupsContent.style.display = 'block';
                ordersContent.style.display = 'none';
               /* moneyRequestsContent.style.display = 'none';*/
            } catch (error) {
                console.error("Error fetching groups:", error);
            }
        }


        // Function to populate dropdowns
        async function populateDropdowns() {
            const accessToken = localStorage.getItem('access_token');
            const url = '/accounts/api/groups/';
        
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
        
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
        
                const data = await response.json();
                const groupNames = [...new Set(data.map(group => group.name))];
                const groupSymbols = [...new Set(data.map(group => group.symbol))];
        
                // Populate Group Name dropdown
                groupNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    groupNameFilter.appendChild(option);
                });
        
                // Populate Group Symbol dropdown
                groupSymbols.forEach(symbol => {
                    const option = document.createElement('option');
                    option.value = symbol;
                    option.textContent = symbol;
                    groupSymbolFilter.appendChild(option);
                });
        
                return groupSymbols; // Return the symbol list
            } catch (error) {
                console.error("Error fetching groups for dropdown:", error);
                return []; // Return an empty array in case of error
            }
        }

        // Event listener for filter button
        document.getElementById('filterGroupsButton').addEventListener('click', () => {
            const selectedName = groupNameFilter.value;
            const selectedSymbol = groupSymbolFilter.value;
            fetchAndDisplayGroups(selectedName, selectedSymbol);
        });

        

        async function fetchAndDisplayOrders(searchTerm = '', orderStatus = '', orderType = '') {
            console.log("Fetching orders with:", searchTerm, orderStatus, orderType);
            const accessToken = localStorage.getItem('access_token');
            let url = '/accounts/api/orders/';
            const queryParams = new URLSearchParams();
        
            if (searchTerm) queryParams.append('search', searchTerm);
            if (orderStatus) queryParams.append('order_status', orderStatus);
            if (orderType) queryParams.append('order_type', orderType);
        
            const queryString = queryParams.toString();
            if (queryString) url += `?${queryString}`;
        
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
        
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/static/accounts/login.html';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
        
                const data = await response.json();
                console.log("Order Data:", data);
                ordersTableBody.innerHTML = '';
        
                data.forEach((order, index) => {
                    const row = ordersTableBody.insertRow();

                    const srNoCell = row.insertCell(0);
                    srNoCell.textContent = index + 1;

                    const orderIdCell = row.insertCell(1);
                    orderIdCell.textContent = order.order_id || "NA";

                    const orderStatusCell = row.insertCell(2);
                    orderStatusCell.textContent = order.order_status || "NA";

                    const userIdCell = row.insertCell(3);
                    userIdCell.textContent = order.order_user_id || "NA";

                    const companyNameCell = row.insertCell(4);
                    companyNameCell.textContent = order.order_company_name || "NA";

                    const orderTypeCell = row.insertCell(5);
                    orderTypeCell.textContent = order.order_type || "NA";

                    const priceCell = row.insertCell(6);
                    priceCell.textContent = order.order_price || "NA";

                    const quantityCell = row.insertCell(7);
                    quantityCell.textContent = order.order_quantity || "NA";

                    const contractValueCell = row.insertCell(8);
                    contractValueCell.textContent = order.contract_value || "NA";

                    const marginCell = row.insertCell(9);
                    marginCell.textContent = order.margin || "NA";

                    const netProfitCell = row.insertCell(10);
                    netProfitCell.textContent = order.net_profit || "NA";

                    const closePriceCell = row.insertCell(11);
                    closePriceCell.textContent = order.close_price || "NA";

                    const swapCell = row.insertCell(12);
                    swapCell.textContent = order.swap || "NA";

                    const commissionCell = row.insertCell(13);
                    commissionCell.textContent = order.commission || "NA";

                    const createdAtCell = row.insertCell(14);
                    if (order.created_at) {
                        const createdAtDate = new Date(order.created_at);
                        const day = String(createdAtDate.getDate()).padStart(2, '0');
                        const month = String(createdAtDate.getMonth() + 1).padStart(2, '0');
                        const year = createdAtDate.getFullYear();
                        const hours = String(createdAtDate.getHours()).padStart(2, '0');
                        const minutes = String(createdAtDate.getMinutes()).padStart(2, '0');
                        const seconds = String(createdAtDate.getSeconds()).padStart(2, '0');

                        const formattedDate = `${day}-${month}-${year}`; 
                        createdAtCell.textContent = formattedDate;
                    } else {
                        createdAtCell.textContent = "NA";
                    }
                });

                liveCustomersContent.style.display = 'none';
                demoCustomersContent.style.display = 'none';
                groupsContent.style.display = 'none';
                ordersContent.style.display = 'block';
               /* moneyRequestsContent.style.display = 'none';*/
            } catch (error) {
                console.error("Error fetching orders:", error);
            }
        }
        document.getElementById('filterOrdersButton').addEventListener('click', () => {
            const searchTerm = document.querySelector('.search-input[data-search-target="orders"]').value;
            const orderStatus = document.getElementById('orderStatusFilter').value;
            const orderType = document.getElementById('orderTypeFilter').value;
            console.log("Search Term:", searchTerm);
            console.log("Order Status:", orderStatus);
            console.log("Order Type:", orderType);
            fetchAndDisplayOrders(searchTerm, orderStatus, orderType);
        });

        /*async function fetchAndDisplayMoneyRequests(searchTerm = '') {
            const accessToken = localStorage.getItem('access_token');
            let url = '/accounts/api/withdrawal-requests/';
            if (searchTerm) {
                url += `?search=${searchTerm}`;
            }
        
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
        
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/static/accounts/login.html';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
        
                const data = await response.json();
                console.log("Money Requests Data:", data);
                moneyRequestsTableBody.innerHTML = '';

                if (data && data.data) {
                    data.data.forEach((request, index) => {
                        const row = moneyRequestsTableBody.insertRow();

                        const srNoCell = row.insertCell(0);
                        srNoCell.textContent = index + 1;

                        const nameCell = row.insertCell(1);
                        nameCell.textContent = request.user_details.name || "NA";

                        const emailCell = row.insertCell(2);
                        emailCell.textContent = request.user_details.email || "NA";

                        const phoneCell = row.insertCell(3);
                        phoneCell.textContent = request.user_details.phone_number || "NA";

                        const amountCell = row.insertCell(4);
                        amountCell.textContent = request.request_details.amount || "NA";

                        const typeCell = row.insertCell(5);
                        typeCell.textContent = request.request_details.type || "NA";

                        const statusCell = row.insertCell(6);
                        statusCell.textContent = request.request_details.status || "NA";

                        const actionsCell = row.insertCell(7);
                        const dropdown = createDropdown(request, 'moneyRequests');
                        actionsCell.appendChild(dropdown);
                    });
                } else {
                    console.error("Invalid or empty data from API:", data);
                }

                liveCustomersContent.style.display = 'none';
                demoCustomersContent.style.display = 'none';
                groupsContent.style.display = 'none';
                ordersContent.style.display = 'none';
                moneyRequestsContent.style.display = 'block';
            } catch (error) {
                console.error("Error fetching money requests:", error);
            }
        }*/

       fetchAndDisplayLiveCustomers();

        const logoutLink = document.getElementById('logout-link');

        logoutLink.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('access_token');
            window.location.href = '/static/accounts/login.html';
        });

        const searchInputs = document.querySelectorAll('.search-input');

        searchInputs.forEach(input => {
            input.addEventListener('input', () => {
                const searchTerm = input.value;
                const target = input.dataset.searchTarget;

                if (target === 'live-customers') {
                    fetchAndDisplayLiveCustomers(searchTerm);
                } else if (target === 'demo-customers') {
                    fetchAndDisplayDemoCustomers(searchTerm);
                } else if (target === 'groups') {
                    const groupNameFilter = document.getElementById('groupNameFilter').value;
                    const groupSymbolFilter = document.getElementById('groupSymbolFilter').value;
                    fetchAndDisplayGroups(searchTerm, groupNameFilter, groupSymbolFilter);
                } else if (target === 'orders') {
                    fetchAndDisplayOrders(searchTerm);
                } /*else if (target === 'money-requests') {
                    fetchAndDisplayMoneyRequests(searchTerm);
                }*/
            });
        });

        

        liveCustomerLink.addEventListener('click', (e) => {
            e.preventDefault();
            liveCustomerLink.classList.add('active');
            demoCustomerLink.classList.remove('active');
            groupsLink.classList.remove('active');
            ordersLink.classList.remove('active');
            /*moneyRequestsLink.classList.remove('active');*/
        
            // Hide all content divs first
            liveCustomersContent.style.display = 'none';
            demoCustomersContent.style.display = 'none';
            groupsContent.style.display = 'none';
            ordersContent.style.display = 'none';
            /*moneyRequestsContent.style.display = 'none';*/
        
            // Show the relevant content
            liveCustomersContent.style.display = 'block';
        
            fetchAndDisplayLiveCustomers();
        });

        demoCustomerLink.addEventListener('click', (e) => {
            e.preventDefault();
            demoCustomerLink.classList.add('active');
            liveCustomerLink.classList.remove('active');
            groupsLink.classList.remove('active');
            ordersLink.classList.remove('active');
            /*moneyRequestsLink.classList.remove('active');*/
        
            // Hide all content divs first
            liveCustomersContent.style.display = 'none';
            demoCustomersContent.style.display = 'none';
            groupsContent.style.display = 'none';
            ordersContent.style.display = 'none';
            /*moneyRequestsContent.style.display = 'none';*/
        
            // Show the relevant content
            demoCustomersContent.style.display = 'block';
        
            fetchAndDisplayDemoCustomers();
        });


        groupsLink.addEventListener('click', (e) => {
            e.preventDefault();
            groupsLink.classList.add('active');
            liveCustomerLink.classList.remove('active');
            demoCustomerLink.classList.remove('active');
            ordersLink.classList.remove('active');
            /*moneyRequestsLink.classList.remove('active');*/
    
            liveCustomersContent.style.display = 'none';
            demoCustomersContent.style.display = 'none';
            ordersContent.style.display = 'none';
            /*moneyRequestsContent.style.display = 'none';*/
    
            groupsContent.style.display = 'block';
            fetchAndDisplayGroups();
        });

        ordersLink.addEventListener('click', (e) => {
            e.preventDefault();
            ordersLink.classList.add('active');
            liveCustomerLink.classList.remove('active');
            demoCustomerLink.classList.remove('active');
            groupsLink.classList.remove('active');
            /*moneyRequestsLink.classList.remove('active');*/
    
            liveCustomersContent.style.display = 'none';
            demoCustomersContent.style.display = 'none';
            groupsContent.style.display = 'none';
           /* moneyRequestsContent.style.display = 'none';*/
    
            ordersContent.style.display = 'block';
            fetchAndDisplayOrders();
        });

       /* moneyRequestsLink.addEventListener('click', (e) => {
            e.preventDefault();
            moneyRequestsLink.classList.add('active');
            liveCustomerLink.classList.remove('active');
            demoCustomerLink.classList.remove('active');
            groupsLink.classList.remove('active');
            ordersLink.classList.remove('active');
    
            liveCustomersContent.style.display = 'none';
            demoCustomersContent.style.display = 'none';
            groupsContent.style.display = 'none';
            ordersContent.style.display = 'none';
    
            moneyRequestsContent.style.display = 'block';
            fetchAndDisplayMoneyRequests();
        });


        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value;
            fetchAndDisplayMoneyRequests(searchTerm); // Directly call the function
        });*/

        
        checkAuthentication();

        async function checkAuthentication() {
            const accessToken = localStorage.getItem('access_token');
            try {
                const response = await fetch('/accounts/api/dashboard/', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    window.location.href = '/static/accounts/login.html';
                }
            } catch (error) {
                console.error("Authentication check failed:", error);
                window.location.href = '/static/accounts/login.html';
            }
        }


    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
</body>

</html>

